name: Test DAGs

on:
  workflow_dispatch:
  push:
    branches:
      - 'main'
    paths:
      - '**.py'
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Get Code
        uses: actions/checkout@v3
      - name: Set Up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip check
      - name: Lint with Flake8
        continue-on-error: true
        run: |
          pip install flake8==7.0.0
          flake8 --ignore E501 ./src/airflow/dags/ -v
      - name: Check code format with black
        continue-on-error: true
        run: |
          pip install pytest-black==0.3.12
          pytest --black -p no:dags/online_retail/dbt/dbt_packages/dbt_utils/tests/conftest.py -v ./src/airflow/dags/
      - name: Test DAGs with Pytest
        run: |
            pip install pytest==8.0.0
            pytest --cache-clear -rsxX -l --tb=short --strict -v ./tests/
